From a70e720b4490bfd582d7744cb13d253bb02ae088 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Thu, 21 Jul 2016 15:14:58 -0500
Subject: [PATCH 2/2] blank-bbbw

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/include/asm/arch-am33xx/ddr_defs.h | 16 ++++++++++
 board/ti/am335x/board.c                     | 45 ++++++++++++++++++++++++++---
 board/ti/am335x/board.h                     |  5 ++++
 board/ti/am335x/mux.c                       |  8 +++--
 include/configs/am335x_evm.h                |  3 +-
 5 files changed, 70 insertions(+), 7 deletions(-)

diff --git a/arch/arm/include/asm/arch-am33xx/ddr_defs.h b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
index 97bbfe2..950e504 100644
--- a/arch/arm/include/asm/arch-am33xx/ddr_defs.h
+++ b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
@@ -140,6 +140,22 @@
 #define K4B2G1646EBIH9_PHY_WR_DATA		0x76
 #define K4B2G1646EBIH9_IOCTRL_VALUE		0x18B
 
+/* Octavo OSD3358 Rev A */
+#define OSD3358A_EMIF_READ_LATENCY		0x100006
+#define OSD3358A_EMIF_TIM1			0x0AAAD4DB
+#define OSD3358A_EMIF_TIM2			0x266B7FDA
+#define OSD3358A_EMIF_TIM3			0x501F867F
+#define OSD3358A_EMIF_SDCFG			0x61C04AB2
+#define OSD3358A_EMIF_SDREF			0x0000093B
+#define OSD3358A_ZQ_CFG				0x50074BE4
+#define OSD3358A_RATIO				0x80
+#define OSD3358A_INVERT_CLKOUT			0x0
+#define OSD3358A_RD_DQS				0x3A
+#define OSD3358A_WR_DQS				0x41
+#define OSD3358A_PHY_FIFO_WE			0x96
+#define OSD3358A_PHY_WR_DATA			0x7B
+#define OWD3358A_IOCTRL_VALUE			0x18B
+
 #define  LPDDR2_ADDRCTRL_IOCTRL_VALUE   0x294
 #define  LPDDR2_ADDRCTRL_WD0_IOCTRL_VALUE 0x00000000
 #define  LPDDR2_ADDRCTRL_WD1_IOCTRL_VALUE 0x00000000
diff --git a/board/ti/am335x/board.c b/board/ti/am335x/board.c
index e5608ac..b9da481 100644
--- a/board/ti/am335x/board.c
+++ b/board/ti/am335x/board.c
@@ -123,6 +123,13 @@ static const struct ddr_data ddr3_beagleblack_data = {
 	.datawrsratio0 = MT41K256M16HA125E_PHY_WR_DATA,
 };
 
+static const struct ddr_data ddr3_osd3358_data = {
+	.datardsratio0 = OSD3358A_RD_DQS,
+	.datawdsratio0 = OSD3358A_WR_DQS,
+	.datafwsratio0 = OSD3358A_PHY_FIFO_WE,
+	.datawrsratio0 = OSD3358A_PHY_WR_DATA,
+};
+
 static const struct ddr_data ddr3_evm_data = {
 	.datardsratio0 = MT41J512M8RH125_RD_DQS,
 	.datawdsratio0 = MT41J512M8RH125_WR_DQS,
@@ -152,6 +159,17 @@ static const struct cmd_control ddr3_beagleblack_cmd_ctrl_data = {
 	.cmd2iclkout = MT41K256M16HA125E_INVERT_CLKOUT,
 };
 
+static const struct cmd_control ddr3_osd3358_cmd_ctrl_data = {
+	.cmd0csratio = OSD3358A_RATIO,
+	.cmd0iclkout = OSD3358A_INVERT_CLKOUT,
+
+	.cmd1csratio = OSD3358A_RATIO,
+	.cmd1iclkout = OSD3358A_INVERT_CLKOUT,
+
+	.cmd2csratio = OSD3358A_RATIO,
+	.cmd2iclkout = OSD3358A_INVERT_CLKOUT,
+};
+
 static const struct cmd_control ddr3_evm_cmd_ctrl_data = {
 	.cmd0csratio = MT41J512M8RH125_RATIO,
 	.cmd0iclkout = MT41J512M8RH125_INVERT_CLKOUT,
@@ -184,6 +202,16 @@ static struct emif_regs ddr3_beagleblack_emif_reg_data = {
 	.emif_ddr_phy_ctlr_1 = MT41K256M16HA125E_EMIF_READ_LATENCY,
 };
 
+static struct emif_regs ddr3_osd3358_emif_reg_data = {
+	.sdram_config = OSD3358A_EMIF_SDCFG,
+	.ref_ctrl = OSD3358A_EMIF_SDREF,
+	.sdram_tim1 = OSD3358A_EMIF_TIM1,
+	.sdram_tim2 = OSD3358A_EMIF_TIM2,
+	.sdram_tim3 = OSD3358A_EMIF_TIM3,
+	.zq_config = OSD3358A_ZQ_CFG,
+	.emif_ddr_phy_ctlr_1 = OSD3358A_EMIF_READ_LATENCY,
+};
+
 static struct emif_regs ddr3_evm_emif_reg_data = {
 	.sdram_config = MT41J512M8RH125_EMIF_SDCFG,
 	.ref_ctrl = MT41J512M8RH125_EMIF_SDREF,
@@ -220,6 +248,8 @@ const struct dpll_params dpll_ddr_evm_sk = {
 		303, OSC-1, 1, -1, -1, -1, -1};
 const struct dpll_params dpll_ddr_bone_black = {
 		400, OSC-1, 1, -1, -1, -1, -1};
+const struct dpll_params dpll_ddr_osd3358 = {
+		400, OSC-1, 1, -1, -1, -1, -1};
 
 void am33xx_spl_board_init(void)
 {
@@ -232,7 +262,7 @@ void am33xx_spl_board_init(void)
 	/* Get the frequency */
 	dpll_mpu_opp100.m = am335x_get_efuse_mpu_max_freq(cdev);
 
-	if (board_is_bone(&header) || board_is_bone_lt(&header)) {
+	if (board_is_bone(&header) || board_is_bone_lt(&header) || board_is_osd3358(&header)) {
 		/* BeagleBone PMIC Code */
 		int usb_cur_lim;
 
@@ -266,7 +296,7 @@ void am33xx_spl_board_init(void)
 		 * Override what we have detected since we know if we have
 		 * a Beaglebone Black it supports 1GHz.
 		 */
-		if (board_is_bone_lt(&header))
+		if (board_is_bone_lt(&header) || board_is_osd3358(&header))
 			dpll_mpu_opp100.m = MPUPLL_M_1000;
 
 		/*
@@ -376,6 +406,8 @@ const struct dpll_params *get_dpll_ddr_params(void)
 
 	if (board_is_evm_sk(&header))
 		return &dpll_ddr_evm_sk;
+	else if (board_is_osd3358(&header))
+		return &dpll_ddr_osd3358;
 	else if (board_is_bone_lt(&header))
 		return &dpll_ddr_bone_black;
 	else if (board_is_evm_15_or_later(&header))
@@ -462,6 +494,11 @@ void sdram_init(void)
 	if (board_is_evm_sk(&header))
 		config_ddr(303, &ioregs_evmsk, &ddr3_data,
 			   &ddr3_cmd_ctrl_data, &ddr3_emif_reg_data, 0);
+	else if (board_is_osd3358(&header))
+		config_ddr(400, &ioregs_bonelt,
+			   &ddr3_osd3358_data,
+			   &ddr3_osd3358_cmd_ctrl_data,
+			   &ddr3_osd3358_emif_reg_data, 0);
 	else if (board_is_bone_lt(&header))
 		config_ddr(400, &ioregs_bonelt,
 			   &ddr3_beagleblack_data,
@@ -518,7 +555,7 @@ int board_late_init(void)
 	struct am335x_baseboard_id header;
 
 	if (read_eeprom(&header) < 0)
-		puts("Could not get board ID.\n");
+		puts("Could not get board ID, assuming OSD3358.\n");
 
 	/* Now set variables based on the header. */
 	strncpy(safe_string, (char *)header.name, sizeof(header.name));
@@ -653,7 +690,7 @@ int board_eth_init(bd_t *bis)
 		puts("Could not get board ID.\n");
 
 	if (board_is_bone(&header) || (board_is_bone_lt(&header) && !board_is_bone_lt_enhanced(&header)) ||
-	    board_is_idk(&header)) {
+	    board_is_idk(&header) || board_is_osd3358(&header)) {
 		writel(MII_MODE_ENABLE, &cdev->miisel);
 		cpsw_slaves[0].phy_if = cpsw_slaves[1].phy_if =
 				PHY_INTERFACE_MODE_MII;
diff --git a/board/ti/am335x/board.h b/board/ti/am335x/board.h
index f083483..c18aa97 100644
--- a/board/ti/am335x/board.h
+++ b/board/ti/am335x/board.h
@@ -45,6 +45,11 @@ static inline int board_is_bone_lt_enhanced(struct am335x_baseboard_id *header)
 			strncmp("SE", header->version, 2) <= 0);
 }
 
+static inline int board_is_osd3358(struct am335x_baseboard_id *header)
+{
+	return 1;
+}
+
 static inline int board_is_evm_sk(struct am335x_baseboard_id *header)
 {
 	return !strncmp("A335X_SK", header->name, HDR_NAME_LEN);
diff --git a/board/ti/am335x/mux.c b/board/ti/am335x/mux.c
index efeabd7..5bbfcb4 100644
--- a/board/ti/am335x/mux.c
+++ b/board/ti/am335x/mux.c
@@ -379,7 +379,11 @@ void enable_board_pin_mux(struct am335x_baseboard_id *header)
 		configure_module_pin_mux(bbb_p9_15_pin_mux);
 #endif
 	} else {
-		puts("Unknown board, cannot configure pinmux.");
-		hang();
+		puts("Unknown board: assuming OSD3358.");
+		configure_module_pin_mux(i2c1_pin_mux);
+		configure_module_pin_mux(mii1_pin_mux);
+		configure_module_pin_mux(mmc0_pin_mux);
+		configure_module_pin_mux(mmc1_pin_mux);
+		configure_module_pin_mux(bbb_p9_15_pin_mux);
 	}
 }
diff --git a/include/configs/am335x_evm.h b/include/configs/am335x_evm.h
index c215e31..44413b5 100644
--- a/include/configs/am335x_evm.h
+++ b/include/configs/am335x_evm.h
@@ -99,7 +99,8 @@
 	func(DHCP, dhcp, na)
 
 #define CONFIG_BOOTCOMMAND \
-	"run findfdt; " \
+	"setenv fdtfile am335x-boneblack-wireless.dtb; " \
+	"setenv fdtbase am335x-boneblack-wireless; " \
 	"run distro_bootcmd"
 
 #include <config_distro_bootcmd.h>
-- 
2.8.1

