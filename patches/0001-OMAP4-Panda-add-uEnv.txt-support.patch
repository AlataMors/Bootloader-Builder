From 7216441fd3d8f85248ecef99b724cf4691570cdd Mon Sep 17 00:00:00 2001
From: John Rigby <john.rigby@linaro.org>
Date: Fri, 1 Jul 2011 00:10:49 +0100
Subject: [PATCH] OMAP4: Panda: add uEnv.txt support

Identical to omap3_beagle.

Signed-off-by: John Rigby <john.rigby@linaro.org>
---
 include/configs/omap4_common.h |   16 ++++++++++++++--
 1 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/include/configs/omap4_common.h b/include/configs/omap4_common.h
index a989721..d51cb32 100644
--- a/include/configs/omap4_common.h
+++ b/include/configs/omap4_common.h
@@ -160,9 +160,13 @@
 		"vram=${vram} " \
 		"root=${mmcroot} " \
 		"rootfstype=${mmcrootfstype}\0" \
-	"loadbootscript=fatload mmc ${mmcdev} ${loadaddr} boot.scr\0" \
+	"bootscr=boot.scr\0" \
+	"loadbootscript=fatload mmc ${mmcdev} ${loadaddr} ${bootscr}\0" \
 	"bootscript=echo Running bootscript from mmc${mmcdev} ...; " \
 		"source ${loadaddr}\0" \
+	"loadbootenv=fatload mmc ${mmcdev} ${loadaddr} uEnv.txt\0" \
+	"importbootenv=echo Importing environment from mmc ...; " \
+		"env import -t $loadaddr $filesize\0" \
 	"loaduimage=fatload mmc ${mmcdev} ${loadaddr} uImage\0" \
 	"mmcboot=echo Booting from mmc${mmcdev} ...; " \
 		"run mmcargs; " \
@@ -170,7 +174,15 @@
 
 #define CONFIG_BOOTCOMMAND \
 	"if mmc rescan ${mmcdev}; then " \
-		"if run loadbootscript; then " \
+		"if run loadbootenv; then " \
+			"echo Loaded environment from ${bootenv};" \
+			"run importbootenv;" \
+			"if test -n $uenvcmd; then " \
+				"echo Running uenvcmd ...;" \
+				"run uenvcmd;" \
+			"fi;" \
+		"elif run loadbootscript; then " \
+			"echo Loaded script from ${bootscr};" \
 			"run bootscript; " \
 		"else " \
 			"if run loaduimage; then " \
-- 
1.7.2.5

